<!DOCTYPE html>
<html lang="zh">

<head>
    <title>图鉴日图归档</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://tu-data.gxb.pub/lib/sql-wasm.js"></script>
    <script src="https://tu-data.gxb.pub/lib/marked.min.js"></script>
    <script src="/main.js"></script>

    <style>
        * {
            overflow-x: hidden;
        }

        body {
            overflow-x: hidden;
        }

        #root {
            max-width: 800px;
            margin: 0 auto;
        }

        a {
            color: #007bff;
            text-decoration: none;
            background-color: transparent;
        }
    </style>

    <!--suppress CssUnusedSymbol -->
    <style>
        .img_div {
            border: 1px solid #000;
            margin: 10px;
            padding: 15px;
            border-radius: 5px;
        }

        .img_title {
            font-size: 25px;
            margin: 0;
            width: 100%;
            max-width: 100%;
        }

        .img_desc {
            margin: 10px 0;
            width: 100%;
            max-width: 100%;
        }

        .img_info {
            font-size: 15px;
            margin: 0;
            width: 100%;
            max-width: 100%;
        }

        .img {
            margin-top: 10px;
            width: 100%;
            max-width: 100%;
        }

    </style>

    <style>
        #float-toolbar {
            position: fixed;
            right: 10px;
            bottom: 10px;
            z-index: 1000;
        }

        #main_toolbar {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        #float-toolbar button {
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
            background-color: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
            width: 50px;
        }
        
        #float-toolbar button:hover {
            background-color: #0056b3;
        }
    </style>

    <style>
        #filter-dialog {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: #fff;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: none;
            max-width: 100%;
        }

        .filter-guidance {
            font-size: 10px;
            max-width: 100%;
        }
    </style>

    <style>

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #load_error {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #load_error button {
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
            background-color: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
        }

    </style>
</head>

<body>

<div id="loading">
    <h1>Loading...</h1>
    <p id="loading_state">正在从服务器获取数据</p>
    <p id="loading_progress">请稍等</p>
</div>

<div id="load_error">
    <h1>Error</h1>
    <p>加载数据失败</p>
    <p>请刷新重试</p>
    <button onclick="window.location.reload()">刷新</button>
</div>

<div id="root">
    <h1>TuArchive</h1>
    <p>图鉴日图归档 <a href="https://file.gxb.pub/local/TuArchive.zip">→获取归档数据</a></p>

    <div id="pics">
        <div id="sort_root">
        </div>
    </div>
</div>

<div id="float-toolbar">
    <div id="main_toolbar">
        <button onclick="window.scrollTo(0, 0)">↑Top</button>
        <button onclick="showOrHideFilterDialog()">Filter</button>
    </div>
    <div id="extra_toolbar">
    </div>
</div>

<div id="filter-dialog">
    <div>
        <label for="filter">Filter:</label>
        <input type="text" id="filter" name="filter">
        <button onclick="load(document.getElementById('filter').value)">Apply</button>
    </div>
    <p class="filter-guidance">
        默认对标题和内容进行模糊查找 <br/>
        使用 @用户名 以根据用户名过滤, 支持模糊查找<br/>
        使用 #日期 以根据日期过滤 <br/>
        使用 = 作为前缀以使用正则表达式, 支持与 @, # 组合使用<br/>
        使用 \@, \#, \= 以搜索@, #, = <br/>
        关键词以空格分隔, 会被视为AND关系 <br/>
    </p>
</div>

<script>

    const data = new DataLoader()

    function load(
        filter = ""
    ) {

        //clear sort_root and extra_toolbar
        document.getElementById("sort_root").innerHTML = "";
        document.getElementById("extra_toolbar").innerHTML = "";

        data.getData(
            function (sorts, pics) {

                let float_bar = document.getElementById("extra_toolbar");

                for (let i = 0; i < sorts.length; i++) {
                    let sort = sorts[i];
                    let div = document.createElement("div");

                    let label = document.createElement("h2");
                    label.innerHTML = sort.name;
                    div.appendChild(label);

                    div.id = "sort_" + sort.id;
                    document.getElementById("sort_root").appendChild(div);

                    let float_button = document.createElement("button");
                    float_button.innerHTML = sort.name;
                    float_button.onclick = function () {
                        //goto target
                        let target = document.getElementById("sort_" + sort.id);
                        if (target) {
                            target.scrollIntoView();
                        }
                    }
                    float_bar.appendChild(float_button);
                }
                for (let i = 0; i < pics.length; i++) {
                    let pic = pics[pics.length - i - 1];

                    if (!filterPic(pic, filter)) {
                        continue;
                    }

                    let img_div = document.createElement("div");
                    img_div.className = "img_div";
                    img_div.id = "pic_" + pic.id;
                    //set text color using pic.textColor
                    img_div.style.color = pic.textColor;
                    //set background color using pic.themeColor
                    img_div.style.backgroundColor = pic.themeColor;

                    let img_title = document.createElement("h4");
                    img_title.innerHTML = pic.title;
                    img_title.className = "img_title";
                    img_div.appendChild(img_title);

                    let img_desc = document.createElement("div");
                    // noinspection JSUnresolvedReference
                    img_desc.innerHTML = marked.parse(pic.content)
                    img_desc.className = "img_desc";
                    img_div.appendChild(img_desc);

                    let img_info = document.createElement("p");
                    img_info.innerHTML = pic.date + " @" + pic.username + " |" + pic.width + "x" + pic.height;
                    img_info.className = "img_info";
                    img_div.appendChild(img_info);

                    let img = document.createElement("img");
                    img.className = "img";
                    img.loading = "lazy";
                    img.src = "https://tu-data.gxb.pub/pictures" + pic.path;
                    img_div.appendChild(img);

                    //get sort_root
                    let sort_root = document.getElementById("sort_" + pic.sortId);
                    if (sort_root) {
                        sort_root.appendChild(img_div);
                        //set img width
                        img.style.width = img_div.offsetWidth - 30 + "px";
                        //set img height
                        img.style.height = img_div.offsetWidth / pic.width * pic.height + "px";
                    }

                    //hide onloading
                    document.getElementById("loading").style.display = "none";
                }
            },
            function (error) {
                console.error(error);
                document.getElementById("loading").style.display = "none";
                document.getElementById("load_error").style.display = "flex";
            }
        )
    }

    function resize() {
        let imgs = document.getElementsByClassName("img");
        for (let i = 0; i < imgs.length; i++) {
            let img = imgs[i];
            let img_div = img.parentElement;
            const origin_width = img.style.width;
            const origin_height = img.style.height;
            img.style.width = img_div.offsetWidth - 30 + "px";
            img.style.height = (img_div.offsetWidth - 30) / parseFloat(origin_width) * parseFloat(origin_height) + "px";
        }
    }

    window.onload = function () {
        load();
    }

    window.onresize = function () {
        resize();
    }

</script>

<script>

    function showFilterDialog() {
        document.getElementById("filter-dialog").style.display = "block";
    }

    function hideFilterDialog() {
        document.getElementById("filter-dialog").style.display = "none";
    }

    function showOrHideFilterDialog() {
        let dialog = document.getElementById("filter-dialog");
        if (dialog.style.display === "block") {
            hideFilterDialog();
        } else {
            showFilterDialog();
        }
    }

    function filterPic(pic, filter) {
        if (filter === null || filter === "") {
            return true;
        }
        let filters = filter.split(" ");

        let re = true

        for (let i = 0; i < filters.length; i++) {
            filter = filters[i];

            if (filter.startsWith("@")) {
                if (pic.username.indexOf(filter.substring(1)) === -1) {
                    re = re && false;
                }
            } else if (filter.startsWith("#")) {
                if (pic.date.indexOf(filter.substring(1)) === -1) {
                    re = re && false;
                }
            } else if (filter.startsWith("=")) {
                if (filter.startsWith("=@")) {
                    let reg = new RegExp(filter.substring(2));
                    if (!reg.test(pic.username)) {
                        re = re && false;
                    }
                } else if (filter.startsWith("=#")) {
                    let reg = new RegExp(filter.substring(2));
                    if (!reg.test(pic.date)) {
                        re = re && false;
                    }
                } else {
                    let reg = new RegExp(filter.substring(1));
                    if (!reg.test(pic.title) && !reg.test(pic.content)) {
                        re = re && false;
                    }
                }
            } else if (filter.startsWith("\\@") || filter.startsWith("\\#") || filter.startsWith("\\=")) {
                if (pic.title.indexOf(filter.substring(1)) === -1 && pic.content.indexOf(filter.substring(1)) === -1) {
                    re = re && false;
                }
            } else {
                if (pic.title.indexOf(filter) === -1 && pic.content.indexOf(filter) === -1) {
                    re = re && false;
                }
            }
        }
        return re;
    }

</script>

</body>